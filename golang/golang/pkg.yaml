name: golang
dependencies:
  - stage: base
  - stage: '{{ if eq .ARCH "aarch64" }}golang-alpine{{ else }}golang-bootstrap{{ end }}'
steps:
  - sources:
      - url: https://dl.google.com/go/go1.17.7.src.tar.gz
        destination: go.src.tar.gz
        sha256: c108cd33b73b1911a02b697741df3dea43e01a5c4e08e409e8b3a0e3745d2b4d
        sha512: ee20a97d19e501ee2c11930548bcacfa8b1e8499bbae15659231548f4b03c13bc92bb20c4ce879f0956c02268e748c73ba56d8b140ce8f134501c33cc8b58d3c

    env:
      GOROOT_BOOTSTRAP: '{{ .TOOLCHAIN }}/go_bootstrap'
      GOROOT_FINAL: '{{ .TOOLCHAIN }}/go'
      CGO_ENABLED: '0'

    prepare:
      - tar -xzf go.src.tar.gz --strip-components=1

    build:
      - cd src && sh make.bash
    install:
      - rm -rf pkg/obj
      - rm -rf pkg/bootstrap
      - rm -f pkg/tool/*/api
      - |
        find src \( -type f -a -name "*_test.go" \) \
        -exec rm -rf \{\} \+
      - |
        find src \( -type d -a -name "testdata" \) \
        -exec rm -rf \{\} \+
      - |
        find src -type f -a \( -name "*.bash" -o -name "*.rc" -o -name "*.bat" \) \
        -exec rm -rf \{\} \+

      - mkdir -p "/rootfs${GOROOT_FINAL}"
      - mv * "/rootfs${GOROOT_FINAL}"
finalize:
  - from: /rootfs
    to: /
